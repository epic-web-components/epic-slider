<link rel="import" href="../polymer/polymer.html">

<dom-module id="epic-slider">
    <template>
        <style>
            :host {
                width: 90%;
                margin: 0 auto;
                overflow-x: hidden;
                white-space: nowrap;
                font-size: 0;
                display: block;
                font-family: "Interstate", helvetica, arial, sans-serif;
            }

            :host .event {
                width: 100%;
                display: inline-block;
                position: relative;
                font-size: 1rem;
                background-color: black;
                background-position: center center;
                background-size: cover;
                min-height: 400px;
            }

            :host .event .controls {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                background: linear-gradient(to top, rgba(0, 0, 0, 0.5) 0%, transparent 50%, transparent 100%);
                height: 100%;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                -webkit-flex-flow: row nowrap;
                -ms-flex-flow: row nowrap;
                flex-flow: row nowrap;
                -webkit-justify-content: space-between;
                -ms-flex-pack: justify;
                justify-content: space-between;
                -webkit-align-items: flex-end;
                -ms-flex-align: end;
                align-items: flex-end;
                padding-bottom: 50px;
            }

            :host .event .controls a.leftArrow,
            :host .event .controls a.rightArrow {
                background-size: contain;
                width: 25px;
                height: 50px;
                text-indent: -9999px;
                color: white;
                display: inline-block;
                background-image: url("img/leftArrow.svg");
                background-repeat: no-repeat;
                background-position: center center;
                margin-bottom: 70px;
                -webkit-flex: 1;
                -ms-flex: 1;
                flex: 1;
            }

            :host .event .controls a.leftArrow {
                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
            }

            :host .event .controls a.rightArrow {
                -webkit-transform: rotate(180deg);
                -ms-transform: rotate(180deg);
                transform: rotate(180deg);
                -webkit-order: 2;
                -ms-flex-order: 2;
                order: 2;
            }

            :host .event .controls .content {
                -webkit-order: 1;
                -ms-flex-order: 1;
                order: 1;
                color: white;
                -webkit-flex: 7;
                -ms-flex: 7;
                flex: 7;
            }

            :host .event .controls .content h2 {
                font-size: 3em;
                text-transform: uppercase;
                line-height: 1.5;
                white-space: normal;
                text-align: left;
                margin: 0;
            }

            :host .event .controls .content h3 {
                font-size: 2em;
                white-space: normal;
                margin: 0;
            }

            :host .event .controls .content a.learnMore {
                background: #c30;
                display: inline-block;
                padding: 1em 2em;
                text-transform: uppercase;
                color: white;
                text-decoration: none;
                margin: 1em auto;
            }
        </style>
        <template is="dom-repeat" items="{{slides}}">
            <div class="event" id="{{item.slug}}" style="background-image: url({{item.image}});">
                <div class="controls">
                    <div class="content">
                        <h2>{{item.name}}</h2>
                        <h3>{{item.startAndEnd}}</h3>
                        <a href="{{item.slug}}" class="learnMore">Learn More</a>
                    </div>
                    <a href="#" class="leftArrow">Left</a>
                    <a href="#" class="rightArrow">Right</a>
                </div>
            </div>
        </template>
    </template>

    <script>
        Polymer({
            /*
              TODO: implement quadratic scrolling (currently linear)
            */

            is: 'epic-slider',

            properties: {
                /** JSON array of data objects */
                slides: {
                    type: Array,
                    value: [],
                    notify: true
                },
                /** Whether to automatically scroll between slides */
                autoSlide: {
                    type: Boolean,
                    value: true
                },
                /** time in ms for slide to automatically change */
                slideTime: {
                    type: Number,
                    value: 3000
                },
                /** time in ms for slide transition */
                slideTransitionTime: {
                    type: Number,
                    value: 400
                },
                /** sets the tick value in ms for slide transitions. Lower is smoother, higher is more performant */
                transitionSmoothness: {
                    type: Number,
                    value: 10
                },
                slideInterval: {
                  // computed: 'computeSetSlideInterval(propertyToWatch, uyr)',
                  //
                  // // calls callbackForWhenThisValueChanges(newValue, oldvalue)
                  // observer: 'callbackForWhenThisValueChanges'
                }
            },

            ready: function() {},

            attached: function() {
                // start auto-slide
                if(this.autoSlide){
                    this.startInterval()
                }

                this.assignArrowClickBinding();
            },

            listeners: {
              /* stop auto-slide when mouse hovers over slider */
              'mouseenter': 'stopInterval',
              'mouseleave': 'startInterval'
            },

            /*
              Assigns navigation binding to right and left arrows
            */
            assignArrowClickBinding: function() {
                var rightArrows = Polymer.dom(this.root).querySelectorAll('a.rightArrow'),
                    leftArrows = Polymer.dom(this.root).querySelectorAll('a.leftArrow'),
                    me = this;

                // assumes there are an equal number of right and left arrows
                //    (move to seperate for loops if not)
                for (i = 0; i < leftArrows.length; i += 1) {
                    leftArrows[i].onclick = function(e) {
                        e.preventDefault();
                        var index = 0,
                            e = this.parentElement.parentElement;
                        while (e = e.previousElementSibling) {
                            ++index;
                        }
                        me.scrollToSlide(index - 1);
                    };

                    rightArrows[i].onclick = function(e) {
                        e.preventDefault();
                        var index = 0,
                            e = this.parentElement.parentElement;
                        while (e = e.previousElementSibling) {
                            ++index;
                        }
                        me.scrollToSlide(index + 1);
                    };
                }
            },

            /*
              Starts auto-slide interval
            */
            startInterval: function() {
                this.slideInterval = setInterval(function() {
                    var currentSlide = this.currentSlide();
                    this.scrollToSlide(currentSlide + 1);
                }.bind(this), this.slideTime);
            },

            /*
              Stops auto-slide
            */
            stopInterval: function() {
                clearInterval(this.slideInterval);
            },

            /*
              Gets current slide number (0 is first slide)
            */
            currentSlide: function() {
                var scrollLeft = Polymer.dom(this).node.scrollLeft,
                    slideWidth = Polymer.dom(this).node.offsetWidth,
                    slideNum = Math.round(scrollLeft / slideWidth);

                return slideNum;
            },

            /*
              Returns the number of slides in the component
            */
            numOfSlides: function() {
                return Polymer.dom(this.root).querySelectorAll('div.event').length;
            },

            /*
              Scrolls to a specific slide number

              @param {num} Number of slide to transition to. Starts at 0
            */
            scrollToSlide: function(num) {
                var slideSize = Polymer.dom(this).node.getBoundingClientRect(),
                    slideWidth = slideSize.right - slideSize.left,
                    numOfSlides = this.numOfSlides() - 1;

                /* edge cases */
                if (num < 0) {
                    num = numOfSlides;
                } else if (num > numOfSlides) {
                    num = 0;
                }

                /* scroll to position (animated) */
                this.scrollToLeft(Polymer.dom(this).node, num * slideWidth, this.slideTransitionTime);
            },

            /*
              Recursive scrolling animation (to left)

              @param {element} Element to scroll
              @param {to} Pixel value to scroll to
              @param {duration} Time (in ms) for animation to take
             */
            scrollToLeft: function(element, to, duration) {
                if (duration <= 0) return;

                var tick = this.transitionSmoothness,
                    difference = to - element.scrollLeft,
                    perTick = difference / duration * tick;

                setTimeout(function() {
                    element.scrollLeft = Math.floor(element.scrollLeft + perTick);
                    if (element.scrollLeft == to) return;
                    this.scrollToLeft(element, to, duration - tick);
                }.bind(this), tick);
            },

            /*
              Adds an additional slide to the component.

              @param {slideData} JSON object containing the following properties:
                'name', 'teaser', 'slug', 'startAndEnd', 'image'
            */
            addSlide: function(slideData) {
                this.push('slides', slideData);
            }
        });
    </script>
</dom-module>
